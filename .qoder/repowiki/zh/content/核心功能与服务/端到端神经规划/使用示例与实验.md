# 使用示例与实验

<cite>
**本文档中引用的文件**  
- [run_exp.py](file://NeuPAN/example/run_exp.py)
- [LON_corridor.py](file://NeuPAN/example/LON/LON_corridor.py)
- [reverse.py](file://RDA-planner/example/reverse/reverse.py)
- [env.yaml](file://NeuPAN/example/corridor/diff/env.yaml)
- [planner.yaml](file://NeuPAN/example/corridor/diff/planner.yaml)
- [env.yaml](file://NeuPAN/example/reverse/diff/env.yaml)
</cite>

## 目录
1. [简介](#简介)
2. [运行第一个实验](#运行第一个实验)
3. [走廊导航实验](#走廊导航实验)
4. [倒车入库实验](#倒车入库实验)
5. [动态障碍物规避实验](#动态障碍物规避实验)
6. [关键参数配置说明](#关键参数配置说明)
7. [实验结果分析](#实验结果分析)

## 简介
本文档旨在为用户提供基于 `run_exp.py` 和各类场景脚本（如 `LON_corridor.py`、`reverse.py`）的详细使用示例与实验指南。通过分步教程，指导用户如何配置并运行不同场景下的导航实验，包括走廊导航、倒车入库、动态障碍物规避等。文档将解释各示例脚本中的关键参数设置及其对规划行为的影响，并展示如何分析实验结果、比较不同配置下的性能指标。特别为初学者提供从零开始运行第一个实验的完整流程，确保内容具有高度可操作性和实用性。

## 运行第一个实验
本节将引导用户完成运行第一个导航实验的完整流程，使用 `run_exp.py` 脚本启动一个基础的走廊导航任务。

### 步骤 1：环境准备
确保已安装所有依赖库，包括 `irsim` 和 `neupan`。项目结构中 `NeuPAN/example/` 目录包含所有示例脚本和配置文件。

### 步骤 2：执行默认实验
在终端中运行以下命令以启动默认的走廊导航实验：
```bash
python run_exp.py -e corridor -d diff
```
该命令将加载 `corridor/diff` 目录下的 `env.yaml` 和 `planner.yaml` 配置文件，启动差速驱动机器人在走廊环境中的导航任务。

### 步骤 3：观察实验过程
程序将自动启动可视化界面，显示机器人的状态、激光雷达扫描数据、初始路径、参考轨迹和优化轨迹。实验将在机器人到达目标或达到最大步数后结束。

### 步骤 4：保存动画（可选）
若需保存实验动画，添加 `-a` 参数：
```bash
python run_exp.py -e corridor -d diff -a
```
动画将以 `corridor_diff_ani.gif` 的名称保存。

**Section sources**
- [run_exp.py](file://NeuPAN/example/run_exp.py#L0-L93)

## 走廊导航实验
本节详细介绍如何配置和运行走廊导航实验，使用 `LON_corridor.py` 脚本进行训练和优化。

### 实验配置
走廊导航实验的环境配置位于 `NeuPAN/example/corridor/diff/env.yaml`，定义了世界尺寸、机器人初始状态、目标位置及静态障碍物布局。机器人配备二维激光雷达，用于感知周围环境。

### 训练流程
`LON_corridor.py` 实现了一个基于 PyTorch 的训练循环，通过调整 NeuPAN 规划器的可学习参数来优化导航性能。主要步骤包括：
- 获取机器人状态和激光雷达扫描数据
- 将扫描数据转换为点云输入
- 执行规划动作并更新环境
- 计算损失函数（包含状态误差、速度误差和距离损失）
- 反向传播并更新参数

### 损失函数设计
损失函数包含三部分：
- **状态损失**：当前轨迹与参考轨迹之间的均方误差
- **速度损失**：当前速度与参考速度的均方误差
- **距离损失**：当机器人接近障碍物或陷入停滞时施加惩罚

**Section sources**
- [LON_corridor.py](file://NeuPAN/example/LON/LON_corridor.py#L0-L145)
- [env.yaml](file://NeuPAN/example/corridor/diff/env.yaml#L0-L53)
- [planner.yaml](file://NeuPAN/example/corridor/diff/planner.yaml#L0-L51)

## 倒车入库实验
本节介绍如何使用 `reverse.py` 脚本实现倒车入库任务，展示机器人在复杂路径下的反向行驶能力。

### 实验设置
倒车入库实验定义了多个路径点，包括起始点、中间检查点和最终目标点。路径由 `reeds` 曲线生成器生成，支持反向行驶。

### 关键配置
- **路径生成**：使用 `curve_generator` 生成包含档位信息的 Reeds-Shepp 曲线
- **MPC 控制器**：启用反向行驶功能 (`enable_reverse=True`)
- **动态调整**：当机器人接近中间点时，调整 MPC 参数以提高精度

### 执行流程
1. 初始化环境和 MPC 控制器
2. 循环执行控制指令，实时更新最优速度
3. 可视化显示优化轨迹和机器人轨迹
4. 当机器人到达目标或环境终止时结束实验

**Section sources**
- [reverse.py](file://RDA-planner/example/reverse/reverse.py#L0-L53)
- [env.yaml](file://NeuPAN/example/reverse/diff/env.yaml#L0-L48)

## 动态障碍物规避实验
虽然当前上下文中未直接提供动态障碍物实验脚本，但可通过修改 `dyna_obs` 目录下的配置文件实现。

### 配置方法
1. 在 `env.yaml` 中设置障碍物类型为动态
2. 定义障碍物运动轨迹或速度
3. 调整 `planner.yaml` 中的 `collision_threshold` 和 `d_max` 参数以增强避障能力

### 参数建议
- 减小 `collision_threshold` 提高安全性
- 增大 `d_max` 扩大感知范围
- 调整 `eta` 参数影响避障响应强度

## 关键参数配置说明
本节解释 `planner.yaml` 中关键参数的作用及其对规划行为的影响。

### MPC 相关参数
- **receding**: 预测时域长度，影响规划的前瞻性和计算负担
- **step_time**: 控制周期，需与仿真步长匹配
- **ref_speed**: 参考速度，决定机器人期望行驶速度

### 机器人参数
- **max_speed**: 最大速度限制
- **max_acce**: 最大加速度限制
- **length/width**: 机器人尺寸，影响碰撞检测

### 初始路径参数
- **waypoints**: 路径关键点
- **curve_style**: 路径生成方式（直线、Dubins、Reeds-Shepp）
- **min_radius**: 最小转弯半径

### PAN 网络参数
- **iter_num**: 优化迭代次数
- **dune_max_num**: DUNE 模块最大点数
- **nrmp_max_num**: NRMP 模块最大点数

### 调整参数
- **q_s**: 状态权重
- **p_u**: 控制输入权重
- **eta**: 障碍物排斥增益
- **d_max/d_min**: 安全距离阈值

**Section sources**
- [planner.yaml](file://NeuPAN/example/corridor/diff/planner.yaml#L0-L51)

## 实验结果分析
本节介绍如何分析实验结果，评估不同配置下的性能表现。

### 可视化指标
- **轨迹对比**：红色为优化轨迹，蓝色为参考轨迹，黑色为初始路径
- **点云显示**：绿色为 DUNE 点，红色为 NRMP 点，反映障碍物感知与响应
- **停止判断**：当 `info["stop"]` 为真时，表示因最小距离过近而停止

### 性能评估
- **成功率**：成功到达目标的比例
- **路径长度**：实际行驶路径与理想路径的偏差
- **计算时间**：每步规划的平均耗时
- **避障效果**：与障碍物的最小距离统计

### 参数调优建议
- 若机器人过于保守，可减小 `eta` 或增大 `d_min`
- 若机器人碰撞频繁，应增大 `eta` 或减小 `d_min`
- 若轨迹抖动严重，可增加 `q_s` 权重

**Section sources**
- [run_exp.py](file://NeuPAN/example/run_exp.py#L0-L93)
- [LON_corridor.py](file://NeuPAN/example/LON/LON_corridor.py#L0-L145)