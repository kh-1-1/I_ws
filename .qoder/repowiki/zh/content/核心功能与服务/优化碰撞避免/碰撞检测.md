# 碰撞检测

<cite>
**本文档中引用的文件**  
- [collision_check.jl](file://OBCA/AutonomousParking/collision_check.jl)
- [obstHrep.jl](file://OBCA/AutonomousParking/obstHrep.jl)
- [reeds_shepp.jl](file://OBCA/AutonomousParking/reeds_shepp.jl)
- [hybrid_a_star.jl](file://OBCA/AutonomousParking/hybrid_a_star.jl)
</cite>

## 目录
1. [引言](#引言)
2. [碰撞检测算法实现](#碰撞检测算法实现)
3. [基于H-表示的障碍物建模方法](#基于h-表示的障碍物建模方法)
4. [Reeds-Shepp路径可行性验证](#reeds-shepp路径可行性验证)
5. [连续碰撞检测优化策略](#连续碰撞检测优化策略)
6. [性能优化建议与实时能力](#性能优化建议与实时能力)
7. [自定义检测算法接口说明](#自定义检测算法接口说明)
8. [结论](#结论)

## 引言
本文档详细分析OBCA（优化型碰撞规避）系统中的碰撞检测模块，重点解析`collision_check.jl`中实现的碰撞检测算法。该模块结合了基于H-表示的障碍物建模（`obstHrep.jl`）和Reeds-Shepp路径可行性验证（`reeds_shepp.jl`），在自动驾驶泊车场景中实现高效、精确的路径规划与碰撞规避。文档将深入探讨其核心算法、集成机制、优化策略及扩展接口，为开发者提供全面的技术参考。

## 碰撞检测算法实现

`collision_check.jl`模块实现了针对车辆运动轨迹的高效碰撞检测算法。其核心是两阶段检测流程：首先进行“整体气泡”（Whole Bubble）粗略检测，然后进行精确的矩形轮廓检查。

在`check_collision`函数中，算法遍历路径上的每一个状态点（x, y, yaw）。对于每个点，它首先计算车辆中心的“气泡”中心位置（`cx`, `cy`），该气泡以`WBUBBLE_R`为半径，覆盖车辆的大部分区域。利用`NearestNeighbors.KDTree`进行空间查询，快速找出所有位于该气泡半径范围内的障碍物点。如果无任何障碍物点在范围内，则跳过该状态点，避免不必要的计算。

若存在潜在障碍物，则进入`rect_check`函数进行精确的矩形碰撞检测。此函数通过坐标变换，将障碍物点从世界坐标系转换到车辆的局部坐标系中。随后，采用“射线投射”（Ray Casting）的变体——**环绕角求和法**（Winding Number Algorithm）来判断点是否在车辆多边形内部。该方法计算从障碍物点到车辆轮廓各边的向量夹角之和，若总和大于π，则判定为发生碰撞。

**本节来源**
- [collision_check.jl](file://OBCA/AutonomousParking/collision_check.jl#L25-L133)

## 基于H-表示的障碍物建模方法

`obstHrep.jl`模块提供了将障碍物顶点转换为H-表示（半空间表示）的功能。H-表示是一种用线性不等式组来描述凸多边形的方法，形式为`A*x <= b`，其中`A`是法向量矩阵，`b`是偏移量向量。这种表示法在优化问题中非常高效，因为它可以直接作为线性约束引入。

`obstHrep`函数接收障碍物的数量`nOb`、每个障碍物的顶点数`vOb`以及顶点列表`lOb`。它遍历每个障碍物的每一对连续顶点，计算通过这两点的直线方程，并根据顶点的顺时针顺序确定不等式的方向（即法向量指向多边形外部）。对于垂直和水平的边，有专门的处理逻辑以保证数值稳定性；对于一般情况，则通过线性方程求解斜率和截距，并构造相应的`A_tmp`和`b_tmp`。

最终，该函数返回一个包含所有障碍物约束的`A_all`和`b_all`矩阵，这些矩阵可直接用于后续的优化求解器中，以确保规划路径满足所有障碍物的避让约束。

**本节来源**
- [obstHrep.jl](file://OBCA/AutonomousParking/obstHrep.jl#L30-L101)

## Reeds-Shepp路径可行性验证

`reeds_shepp.jl`模块实现了Reeds-Shepp曲线路径规划器，用于生成车辆在任意起始和目标位姿之间满足曲率约束的最短路径。Reeds-Shepp曲线考虑了车辆的前进、后退和转向能力，能够生成包含直线（S）、左转（L）和右转（R）的多种路径组合。

`calc_shortest_path`函数是核心入口，它调用`calc_paths`生成所有可能的路径类型（如CSC、CCC、CCSC等），然后选择总长度最短的一条。`generate_path`函数负责生成具体的路径点，通过`interpolate`函数对每一段路径（直线或圆弧）进行离散化采样。

在OBCA框架中，Reeds-Shepp路径被用作**启发式扩展**（Analytic Expansion）。在Hybrid A*搜索过程中，当一个节点接近目标时，系统会尝试用Reeds-Shepp算法直接连接该节点与目标节点。如果生成的路径通过了`collision_check`的验证，则该路径被采纳，从而极大地加速了搜索过程。

**本节来源**
- [reeds_shepp.jl](file://OBCA/AutonomousParking/reeds_shepp.jl#L25-L850)

## 连续碰撞检测优化策略

为了在优化过程中高效地进行连续碰撞检测，OBCA采用了多种优化策略：

1.  **时间离散化**：连续的车辆轨迹被离散化为一系列状态点（x, y, yaw）。碰撞检测在这些离散点上进行，将连续问题转化为离散问题。`STEP_SIZE`参数控制了离散化的粒度，较小的步长能提高检测精度但增加计算量。

2.  **空间查询优化**：利用`NearestNeighbors.KDTree`数据结构对障碍物点进行索引。在`check_collision`函数中，`inrange`查询能在O(log n)时间内找到所有位于“气泡”内的障碍物点，避免了对所有障碍物进行全量遍历，显著提升了查询效率。

3.  **两阶段检测**：采用“整体气泡”粗检和“矩形轮廓”精检的两阶段策略。第一阶段快速排除大量无关的障碍物，只有在气泡内有障碍物时才进行计算量更大的精确矩形检查，实现了计算资源的合理分配。

4.  **启发式路径扩展**：在Hybrid A*的`analystic_expantion`函数中，使用Reeds-Shepp路径进行大步长扩展。这不仅减少了需要进行碰撞检测的节点数量，而且生成的路径本身是运动学可行的，提高了搜索效率。

**本节来源**
- [collision_check.jl](file://OBCA/AutonomousParking/collision_check.jl#L25-L133)
- [hybrid_a_star.jl](file://OBCA/AutonomousParking/hybrid_a_star.jl#L233-L286)

## 性能优化建议与实时能力

为提升OBCA在高动态环境下的实时碰撞检测能力，可考虑以下优化建议：

1.  **KD-Tree更新策略**：在动态环境中，障碍物位置会变化。应设计高效的KD-Tree更新机制，如增量式更新或定期重建，以平衡查询效率和更新开销。

2.  **并行化碰撞检测**：`check_collision`函数中对路径上各点的检测是相互独立的，可以利用Julia的并行计算能力进行并行化处理，充分利用多核CPU资源。

3.  **自适应离散化**：根据车辆速度和曲率动态调整`STEP_SIZE`。在高速或大曲率转弯时使用更小的步长以保证安全，在低速或直线行驶时使用较大的步长以提高效率。

4.  **缓存与预计算**：对于静态障碍物，其H-表示（`A_all`, `b_all`）可以预先计算并缓存，避免在每次优化迭代中重复计算。

5.  **硬件加速**：考虑将核心计算（如KD-Tree查询、矩阵运算）移植到GPU上执行，以获得更高的计算吞吐量。

通过上述优化，OBCA系统能够在保证安全性的前提下，满足自动驾驶泊车对实时性的严格要求。

## 自定义检测算法接口说明

OBCA的模块化设计允许开发者轻松集成自定义的碰撞检测算法。主要的扩展点如下：

1.  **替换`check_collision`函数**：开发者可以实现自己的碰撞检测逻辑，例如使用更复杂的车辆模型（如自行车模型）或不同的障碍物表示（如Voxel Grid）。新函数需保持与原函数相同的输入输出接口：`(x::Array{Float64}, y::Array{Float64}, yaw::Array{Float64}, kdtree::KDTree, ox::Array{Float64}, oy::Array{Float64}) -> Bool`。

2.  **扩展Reeds-Shepp路径集**：可以通过修改`generate_path`函数，添加新的路径类型（如更复杂的CSCCSC等），以探索更丰富的路径空间。

3.  **集成其他路径规划器**：`analystic_expantion`函数中的启发式扩展不限于Reeds-Shepp。开发者可以集成Dubins路径、样条曲线或其他运动规划器作为替代或补充。

4.  **自定义障碍物模型**：`obstHrep`函数可以被扩展以支持非凸多边形（通过分解为多个凸多边形）或圆形障碍物，从而适应更复杂的环境。

通过修改`hybrid_a_star.jl`中的调用逻辑，即可将自定义的检测或规划模块无缝集成到OBCA的整体框架中。

**本节来源**
- [collision_check.jl](file://OBCA/AutonomousParking/collision_check.jl#L25-L133)
- [hybrid_a_star.jl](file://OBCA/AutonomousParking/hybrid_a_star.jl#L233-L286)

## 结论
OBCA的碰撞检测模块通过巧妙地结合H-表示、Reeds-Shepp路径和两阶段检测策略，实现了高效、精确的碰撞规避。其核心算法在保证数学严谨性的同时，通过KD-Tree和启发式扩展等优化手段，确保了在复杂泊车场景下的实时性能。模块化的代码结构为开发者提供了清晰的接口，便于进行算法定制和性能优化，使其成为一个强大且灵活的自动驾驶路径规划解决方案。