# 编码标准

<cite>
**本文档中引用的文件**  
- [pyproject.toml](file://NeuPAN/pyproject.toml)
- [setup.py](file://AEMCARL/setup.py)
- [setup.py](file://CrowdNav/setup.py)
- [setup.py](file://RDA-planner/setup.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构与语言分布](#项目结构与语言分布)
3. [Python 编码规范](#python-编码规范)
4. [C++ 编码规范](#c-编码规范)
5. [Julia 编码规范](#julia-编码规范)
6. [代码格式化工具配置](#代码格式化工具配置)
7. [依赖管理与包版本控制](#依赖管理与包版本控制)
8. [子项目特定编码约定](#子项目特定编码约定)
9. [代码示例与常见错误](#代码示例与常见错误)
10. [结论](#结论)

## 简介
本文档全面介绍项目中采用的编码规范和代码风格要求，涵盖 Python、C++ 和 Julia 多种编程语言。基于 `pyproject.toml` 和 `setup.py` 配置文件，说明代码格式化工具（如 black、flake8）的使用方法和配置参数。解释配置文件中定义的依赖管理、包版本控制和构建指令。针对不同子项目（如 NeuPAN、RDA-planner、teb_local_planner）的特定编码约定进行说明，确保代码一致性。提供符合规范的代码写法示例，并指出常见错误模式。

## 项目结构与语言分布
项目包含多个子模块，使用多种编程语言实现不同功能：
- **Python**：NeuPAN、RDA-planner、AEMCARL、CrowdNav 等主要使用 Python 实现算法逻辑和配置管理。
- **C++**：teb_local_planner、hybrid_astar_planner 等 ROS 导航模块使用 C++ 实现高性能路径规划。
- **Julia**：H-OBCA、OBCA 等优化类路径规划器使用 Julia 实现数学建模与求解。

各子项目独立管理依赖和构建流程，通过统一的编码规范保证跨语言协作的一致性。

## Python 编码规范
Python 代码遵循 PEP 8 基本风格指南，并结合项目实际需求进行扩展：
- 使用 4 个空格缩进，禁止使用 Tab。
- 行长度限制为 88 字符（black 默认值）。
- 模块级常量使用 `UPPER_CASE`，类名使用 `CamelCase`，函数和变量使用 `snake_case`。
- 类方法间空一行，函数间空两行。
- 所有导入按标准库、第三方库、本地模块分组，每组之间空一行。
- 类型注解在 Python 3.10+ 环境中广泛使用。

**Section sources**
- [pyproject.toml](file://NeuPAN/pyproject.toml#L1-L30)
- [setup.py](file://AEMCARL/setup.py#L1-L32)

## C++ 编码规范
C++ 代码主要用于 ROS 导航模块，遵循 Google C++ 风格指南的简化版本：
- 使用 2 个空格缩进。
- 类成员变量以 `_` 后缀标识（如 `robot_pose_`）。
- 枚举类型使用 `kEnumValue` 命名风格。
- 头文件使用 `#ifndef`/`#define` 防卫。
- 类定义中 `public:`、`protected:`、`private:` 明确划分。
- 成员函数参数按值传递或 `const &` 引用传递，避免原始指针。
- 使用 `Eigen::make_aligned_operator_new` 处理 SIMD 对齐内存分配。

**Section sources**
- [teb_local_planner_ros.h](file://teb_local_planner/include/teb_local_planner/teb_local_planner_ros.h#L78-L126)
- [teb_config.cpp](file://teb_local_planner/src/teb_config.cpp#L26-L38)

## Julia 编码规范
Julia 代码用于高性能数值计算和优化求解，遵循 Julia 官方风格建议：
- 使用 4 个空格缩进。
- 模块名和类型名使用 `CamelCase`，函数和变量使用 `snake_case`。
- 文件扩展名为 `.jl`，每个文件对应一个主要函数或模块。
- 函数命名体现操作语义，如 `main.jl` 为主入口，`setup.jl` 为初始化脚本。
- 注释使用 `#` 开头，多行注释用 `#= =#` 包裹。
- 模块间通过 `include()` 显式加载依赖。

**Section sources**
- [setup.jl](file://H-OBCA/setup.jl#L0-L27)
- [README.md](file://H-OBCA/README.md#L62-L66)

## 代码格式化工具配置
项目通过配置文件统一代码格式化规则，确保跨团队一致性。

### Python 格式化工具
尽管当前配置文件中未显式声明 black 或 flake8，但根据项目结构和 Python 生态实践，推荐使用以下工具：
- **black**：作为默认代码格式化器，配置行宽为 88。
- **flake8**：用于静态检查，禁用部分过于严格的规则（如 E203、W503）。
- **isort**：自动排序和分组导入语句。

理想配置应在 `pyproject.toml` 中添加 `[tool.black]` 和 `[tool.flake8]` 段落。

**Section sources**
- [pyproject.toml](file://NeuPAN/pyproject.toml#L1-L30)

## 依赖管理与包版本控制
项目使用现代 Python 构建系统进行依赖管理，确保可重复构建。

### pyproject.toml 配置
NeuPAN 子项目使用 `pyproject.toml` 定义构建元数据和依赖：
- 指定构建后端为 `setuptools.build_meta`。
- 声明项目名称、版本、作者、Python 版本要求（>=3.10）。
- 列出核心依赖项，包括 `torch>=2.1.0`、`scipy<=1.13.0` 等精确版本约束。
- 定义可选依赖（如 `irsim`），支持 `extras_require` 扩展安装。

```toml
[project]
name = 'neupan'
version = "1.1"
requires-python = ">= 3.10"
dependencies = [
    'cvxpylayers',
    'numpy',
    'scipy<=1.13.0',
    "torch>=2.1.0",
]
```

### setup.py 配置
其他子项目（AEMCARL、CrowdNav、RDA-planner）使用传统 `setup.py`：
- 明确列出 `install_requires` 第三方依赖。
- RDA-planner 固定 `cvxpy==1.5.2` 版本，确保数值求解稳定性。
- AEMCARL 和 CrowdNav 共享相似依赖集（`torch`, `gym`, `numpy`），体现功能相关性。
- 使用 `extras_require` 定义测试依赖（`pylint`, `pytest`）。

**Section sources**
- [pyproject.toml](file://NeuPAN/pyproject.toml#L1-L30)
- [setup.py](file://RDA-planner/setup.py#L1-L20)

## 子项目特定编码约定
各子项目根据技术栈和应用场景制定特定编码规范。

### NeuPAN 编码约定
- 所有配置文件使用 `.yaml` 格式，与 Python 模块分离。
- 核心算法模块组织在 `neupan/blocks/` 目录下，按功能划分。
- 使用 `__init__.py` 导出公共接口，控制模块可见性。
- 机器人模型配置通过类封装，支持继承扩展。

### RDA-planner 编码约定
- MPC 求解器与 RDA 算法分离，`mpc.py` 和 `rda_solver.py` 职责分明。
- 配置参数集中管理，`.yaml` 文件与示例脚本配对存放。
- 数学运算优先使用 `numpy` 向量化操作，避免显式循环。
- 日志输出使用 `matplotlib` 可视化中间结果，辅助调试。

### teb_local_planner 编码约定
- C++ 类命名清晰反映功能，如 `TebLocalPlannerROS` 继承 ROS 接口。
- 成员变量统一加 `_` 后缀，提高可读性。
- 使用 `Eigen` 线性代数库处理位姿和速度计算。
- ROS 日志宏（`ROS_WARN`, `ROS_ERROR`）规范错误提示。

**Section sources**
- [pyproject.toml](file://NeuPAN/pyproject.toml#L1-L30)
- [setup.py](file://RDA-planner/setup.py#L1-L20)
- [teb_local_planner_ros.h](file://teb_local_planner/include/teb_local_planner/teb_local_planner_ros.h#L78-L126)

## 代码示例与常见错误
### 符合规范的 Python 示例
```python
# neuPAN 配置加载示例
import yaml
from neupan.robot.robot import RobotModel

class NeuPANConfig:
    def __init__(self, config_path: str):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        self.robot = RobotModel(self.config['robot'])
```

### 符合规范的 C++ 示例
```cpp
// teb_local_planner 中的成员函数
bool TebLocalPlannerROS::setPlan(const std::vector<geometry_msgs::PoseStamped>& orig_global_plan) {
  if (!initialized_) {
    ROS_ERROR("teb_local_planner has not been initialized");
    return false;
  }
  global_plan_ = orig_global_plan;
  goal_reached_ = false;
  return true;
}
```

### 常见错误模式
- **Python**：未使用类型注解、过度嵌套、忽略异常处理。
- **C++**：未初始化成员变量、内存泄漏、不使用 const 修饰只读参数。
- **Julia**：未预分配数组导致频繁 GC、使用全局变量影响性能。

**Section sources**
- [pyproject.toml](file://NeuPAN/pyproject.toml#L1-L30)
- [setup.py](file://RDA-planner/setup.py#L1-L20)
- [teb_local_planner_ros.cpp](file://teb_local_planner/src/teb_local_planner_ros.cpp#L202-L246)

## 结论
本项目通过统一的编码规范和配置管理机制，实现了多语言协作下的代码一致性。Python 子项目采用现代构建系统（pyproject.toml）管理依赖，C++ 模块遵循清晰的命名和内存管理规范，Julia 代码专注于数值计算效率。建议未来补充 black、flake8 等格式化工具配置，进一步自动化代码风格检查。各子项目应维护各自的 CONTRIBUTING.md 文件，细化本地编码约定，提升协作效率。